#!/bin/bash

#export VALGRIND='valgrind --tool=memcheck --leak-check=yes --show-reachable=yes'
export VALGRIND=''

cd tests || exit 1
failed=0

for t in *.v; do
  if [ -e "${t}.flags" ]; then
    flags=$(cat "${t}.flags")
  else
    flags=""
  fi

  base="${t%.*}"

  # Run ifa
  # shellcheck disable=SC2086
  $VALGRIND ../ifa -D.. $flags "$t" > "${t}.out"

  # Append basename
  echo "$base" >> "${t}.out"

  # Run the compiled binary
  ./"$base" >> "${t}.out"

  # Cleanup
  if [ -n "$WINDIR" ]; then
    rm -f "${base}.exe"
  else
    rm -f "$base"
  fi

  # Diff
  diff "${t}.out" "${t}.check"
  if [ $? -ne 0 ]; then
    echo "$t ******** FAILED ********"
    failed=$((failed + 1))
  else
    echo "$t PASSED"
  fi
done

echo "---------------------------------------"
if [ "$failed" -eq 0 ]; then
  echo "ALL tests PASSED"
else
  echo "******** $failed test(s) FAILED *********"
fi
